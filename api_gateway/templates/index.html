<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Lan√ßamentos Financeiros</title>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 250px;
            background: #f8f9fa;
            padding: 30px 20px;
            border-right: 1px solid #e9ecef;
        }

        .nav-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .nav-button.active {
            background: #27ae60;
        }

        .content {
            flex: 1;
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-edit:hover {
            background: #e67e22;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .action-buttons {
            white-space: nowrap;
        }
        
        .charts-container {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .chart-item {
            flex: 1;
            min-height: 200px;
            max-height: 250px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 12px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .chart-item {
                min-height: 180px;
                max-height: 220px;
                padding: 8px;
            }
        }
        
        .chart-loading, .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            max-height: 220px;
            text-align: center;
            color: #666;
            font-size: 12px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .chart-error {
            border-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .chart-loading {
            border-color: #3498db;
            background: #f0f8ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ Sistema de Lan√ßamentos Financeiros</h1>
            <p>Microservices com Flask - Gest√£o de Usu√°rios e Transa√ß√µes</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <button class="nav-button active" onclick="showSection('dashboard')">üìä Dashboard</button>
                <button class="nav-button" onclick="showSection('users')">üë• Usu√°rios</button>
                <button class="nav-button" onclick="showSection('transactions')">üí≥ Transa√ß√µes</button>
                <button class="nav-button" onclick="showSection('new-transaction')">‚ûï Nova Transa√ß√£o</button>
                <button class="nav-button" onclick="showSection('reports')">üìà Relat√≥rios</button>
            </div>

            <div class="content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <h2>üìä Dashboard</h2>
                    <div class="stats">
                        <div class="stat-card">
                            <h3 id="total-users">-</h3>
                            <p>Total de Usu√°rios</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="total-transactions">-</h3>
                            <p>Total de Transa√ß√µes</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="total-amount">-</h3>
                            <p>Valor Total</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üé® Visualiza√ß√£o de Dados</h3>
                        <div class="charts-container">
                            <!-- Gr√°fico: Valor por Usu√°rio -->
                            <div class="chart-item">
                                <div class="chart-title">üë• Valor Gasto por Usu√°rio</div>
                                <canvas id="userValueChart"></canvas>
                            </div>
                                            
                            <!-- Gr√°fico: Valor por Tipo de Cart√£o -->
                            <div class="chart-item">
                                <div class="chart-title">üí≥ Valor por Tipo de Cart√£o</div>
                                <canvas id="cardTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üè• Status dos Microservices</h3>
                    <div id="health-status">Carregando...</div>
                </div>

                <!-- Users Section -->
                <div id="users" class="section">
                    <h2>üë• Gest√£o de Usu√°rios</h2>
                    <div class="card">
                        <h3>Criar Novo Usu√°rio</h3>
                        <form id="user-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="user-name">Nome:</label>
                                    <input type="text" id="user-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="user-email">Email:</label>
                                    <input type="email" id="user-email" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Criar Usu√°rio</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Lista de Usu√°rios</h3>
                        <div id="users-list">Carregando...</div>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div id="transactions" class="section">
                    <h2>üí≥ Lista de Transa√ß√µes</h2>
                    <div class="card">
                        <div id="transactions-list">Carregando...</div>
                    </div>
                </div>

                <!-- New Transaction Section -->
                <div id="new-transaction" class="section">
                    <h2>‚ûï Nova Transa√ß√£o</h2>
                    <div class="card">
                        <form id="transaction-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="transaction-user">Usu√°rio:</label>
                                    <select id="transaction-user" required>
                                        <option value="">Selecione um usu√°rio...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="transaction-amount">Valor (R$):</label>
                                    <input type="number" id="transaction-amount" step="0.01" min="0.01" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="transaction-description">Descri√ß√£o:</label>
                                <input type="text" id="transaction-description" required placeholder="Ex: Compra no supermercado">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="transaction-card-type">Tipo de Cart√£o:</label>
                                    <select id="transaction-card-type" required>
                                        <option value="">Selecione o tipo...</option>
                                        <option value="Cr√©dito">Cr√©dito</option>
                                        <option value="D√©bito">D√©bito</option>
                                        <option value="Pr√©-pago">Pr√©-pago</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="transaction-card-final">√öltimos 4 d√≠gitos:</label>
                                    <input type="text" id="transaction-card-final" maxlength="4" pattern="[0-9]{4}" required placeholder="1234">
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">üíæ Salvar Transa√ß√£o</button>
                            <button type="button" class="btn btn-secondary" onclick="clearTransactionForm()">üîÑ Limpar</button>
                        </form>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports" class="section">
                    <h2>üìà Relat√≥rios</h2>
                    <div class="card">
                        <h3>Relat√≥rio por Usu√°rio</h3>
                        <div class="form-group">
                            <label for="report-user">Selecione o Usu√°rio:</label>
                            <select id="report-user">
                                <option value="">Selecione um usu√°rio...</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateReport()">Gerar Relat√≥rio</button>
                    </div>
                    <div id="report-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Transa√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Transa√ß√£o</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="edit-transaction-form">
                <input type="hidden" id="edit-transaction-id">
                
                <div class="form-group">
                    <label for="edit-transaction-description">Descri√ß√£o:</label>
                    <input type="text" id="edit-transaction-description" required placeholder="Ex: Compra no supermercado">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-transaction-amount">Valor (R$):</label>
                        <input type="number" id="edit-transaction-amount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-transaction-card-type">Tipo de Cart√£o:</label>
                        <select id="edit-transaction-card-type" required>
                            <option value="">Selecione o tipo...</option>
                            <option value="Cr√©dito">Cr√©dito</option>
                            <option value="D√©bito">D√©bito</option>
                            <option value="Pr√©-pago">Pr√©-pago</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-transaction-card-final">√öltimos 4 d√≠gitos:</label>
                    <input type="text" id="edit-transaction-card-final" maxlength="4" pattern="[0-9]{4}" required placeholder="1234">
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Vari√°veis globais para os gr√°ficos
        let userValueChart = null;
        let cardTypeChart = null;
        
        // Load charts data and render charts with retry mechanism
        async function loadCharts(retryCount = 0) {
            const maxRetries = 3;
            const retryDelay = 2000; // 2 seconds
            
            try {
                showChartsLoading();
                
                const response = await fetch(`${API_BASE}/transactions/charts/aggregated`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Verifica se os dados s√£o v√°lidos
                if (!data || (!data.dados_por_usuario && !data.dados_por_cartao)) {
                    throw new Error('Dados de gr√°fico inv√°lidos ou vazios');
                }
                
                // Cria gr√°fico de valor por usu√°rio
                createUserValueChart(data.dados_por_usuario || {});
                
                // Cria gr√°fico de valor por tipo de cart√£o
                createCardTypeChart(data.dados_por_cartao || {});
                
                hideChartsLoading();
                
            } catch (error) {
                console.error('Erro ao carregar dados dos gr√°ficos:', error);
                
                if (retryCount < maxRetries) {
                    console.log(`Tentando novamente em ${retryDelay/1000} segundos... (tentativa ${retryCount + 1}/${maxRetries})`);
                    showChartsRetrying(retryCount + 1, maxRetries);
                    
                    setTimeout(() => {
                        loadCharts(retryCount + 1);
                    }, retryDelay);
                } else {
                    // Se todas as tentativas falharam, oferece modo demo
                    showChartsDemo();
                }
            }
        }
        
        // Mostra estado de carregamento dos gr√°ficos
        function showChartsLoading() {
            const userChart = document.getElementById('userValueChart');
            const cardChart = document.getElementById('cardTypeChart');
            
            if (userChart) {
                userChart.style.display = 'none';
                userChart.parentElement.innerHTML = userChart.parentElement.innerHTML.replace(/<canvas[^>]*><\/canvas>/, '<div class="chart-loading">üìä Carregando gr√°fico...</div>');
            }
            
            if (cardChart) {
                cardChart.style.display = 'none';
                cardChart.parentElement.innerHTML = cardChart.parentElement.innerHTML.replace(/<canvas[^>]*><\/canvas>/, '<div class="chart-loading">üìä Carregando gr√°fico...</div>');
            }
        }
        
        // Mostra estado de tentativa de reconex√£o
        function showChartsRetrying(attempt, maxAttempts) {
            const loadingDivs = document.querySelectorAll('.chart-loading');
            loadingDivs.forEach(div => {
                div.innerHTML = `üîÑ Tentando reconectar... (${attempt}/${maxAttempts})`;
            });
        }
        
        // Esconde estado de carregamento
        function hideChartsLoading() {
            const loadingDivs = document.querySelectorAll('.chart-loading, .chart-error');
            loadingDivs.forEach(div => {
                const canvas = document.createElement('canvas');
                if (div.parentElement.querySelector('.chart-title').textContent.includes('Usu√°rio')) {
                    canvas.id = 'userValueChart';
                } else {
                    canvas.id = 'cardTypeChart';
                }
                div.parentElement.replaceChild(canvas, div);
            });
        }
        
        // Mostra erro nos gr√°ficos
        function showChartsError(errorMessage) {
            const loadingDivs = document.querySelectorAll('.chart-loading');
            loadingDivs.forEach(div => {
                div.className = 'chart-error';
                div.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                        <div style="font-size: 16px; margin-bottom: 10px;"><strong>Erro ao carregar gr√°fico</strong></div>
                        <div style="font-size: 12px; margin-bottom: 15px; color: #666;">${errorMessage}</div>
                        <button onclick="loadCharts(0)" class="btn btn-primary" style="font-size: 12px; padding: 8px 16px; margin-right: 10px;">üîÑ Tentar Novamente</button>
                        <button onclick="showChartsDemo()" class="btn btn-secondary" style="font-size: 12px; padding: 8px 16px;">üé≠ Ver Demo</button>
                    </div>
                `;
            });
        }
        
        // Mostra gr√°ficos com dados de demonstra√ß√£o
        function showChartsDemo() {
            console.log('Carregando gr√°ficos em modo demonstra√ß√£o');
            
            // Dados de demonstra√ß√£o
            const demoUserData = {
                '1': {
                    nome: 'Jo√£o Silva',
                    total_gasto: 1250.75,
                    total_transacoes: 8
                },
                '2': {
                    nome: 'Maria Santos',
                    total_gasto: 892.30,
                    total_transacoes: 5
                },
                '3': {
                    nome: 'Pedro Oliveira',
                    total_gasto: 654.90,
                    total_transacoes: 3
                }
            };
            
            const demoCardData = {
                'Cr√©dito': {
                    total_gasto: 1450.20,
                    total_transacoes: 9
                },
                'D√©bito': {
                    total_gasto: 987.45,
                    total_transacoes: 5
                },
                'Pr√©-pago': {
                    total_gasto: 360.30,
                    total_transacoes: 2
                }
            };
            
            // Restaura os canvas
            hideChartsLoading();
            
            // Adiciona indica√ß√£o de modo demo
            const chartTitles = document.querySelectorAll('.chart-title');
            chartTitles.forEach(title => {
                if (!title.textContent.includes('(DEMO)')) {
                    title.innerHTML += ' <span style="color: #f39c12; font-size: 12px;">(DEMO)</span>';
                }
            });
            
            // Cria os gr√°ficos com dados demo
            setTimeout(() => {
                createUserValueChart(demoUserData);
                createCardTypeChart(demoCardData);
                
                // Mostra alerta informativo
                showAlert('Gr√°ficos carregados em modo demonstra√ß√£o com dados de exemplo', 'success');
            }, 100);
        }
        
        // Cria gr√°fico de valor por usu√°rio
        function createUserValueChart(dadosUsuarios) {
            const ctx = document.getElementById('userValueChart');
            if (!ctx) {
                console.error('Canvas userValueChart n√£o encontrado');
                return;
            }
            
            const context = ctx.getContext('2d');
            
            // Verifica se h√° dados
            if (!dadosUsuarios || Object.keys(dadosUsuarios).length === 0) {
                // Destr√≥i gr√°fico anterior se existir
                if (userValueChart) {
                    userValueChart.destroy();
                }
                
                // Mostra mensagem de sem dados
                ctx.parentElement.innerHTML = `
                    <div class="chart-title">üë• Valor Gasto por Usu√°rio</div>
                    <div style="text-align: center; padding: 40px; color: #95a5a6;">
                        <div style="font-size: 32px; margin-bottom: 15px;">üìà</div>
                        <div><strong>Nenhum dado dispon√≠vel</strong></div>
                        <div style="font-size: 12px; margin-top: 8px;">Adicione algumas transa√ß√µes para ver o gr√°fico</div>
                    </div>
                `;
                return;
            }
            
            // Prepara os dados
            const labels = [];
            const valores = [];
            const cores = [
                '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#f1c40f', '#e91e63'
            ];
            
            Object.entries(dadosUsuarios).forEach(([userId, dados], index) => {
                labels.push(dados.nome || `Usu√°rio ${userId}`);
                valores.push(dados.total_gasto || 0);
            });
            
            // Destr√≥i gr√°fico anterior se existir
            if (userValueChart) {
                userValueChart.destroy();
            }
            
            userValueChart = new Chart(context, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor Total Gasto (R$)',
                        data: valores,
                        backgroundColor: cores.slice(0, labels.length),
                        borderColor: cores.slice(0, labels.length).map(cor => cor.replace('0.8', '1')),
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            titleFont: {
                                size: 10
                            },
                            bodyFont: {
                                size: 9
                            },
                            callbacks: {
                                label: function(context) {
                                    return `R$ ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 9
                                },
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 9
                                },
                                maxRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Cria gr√°fico de valor por tipo de cart√£o
        function createCardTypeChart(dadosCartao) {
            const ctx = document.getElementById('cardTypeChart');
            if (!ctx) {
                console.error('Canvas cardTypeChart n√£o encontrado');
                return;
            }
            
            const context = ctx.getContext('2d');
            
            // Verifica se h√° dados
            if (!dadosCartao || Object.keys(dadosCartao).length === 0) {
                // Destr√≥i gr√°fico anterior se existir
                if (cardTypeChart) {
                    cardTypeChart.destroy();
                }
                
                // Mostra mensagem de sem dados
                ctx.parentElement.innerHTML = `
                    <div class="chart-title">üí≥ Valor por Tipo de Cart√£o</div>
                    <div style="text-align: center; padding: 40px; color: #95a5a6;">
                        <div style="font-size: 32px; margin-bottom: 15px;">üìä</div>
                        <div><strong>Nenhum dado dispon√≠vel</strong></div>
                        <div style="font-size: 12px; margin-top: 8px;">Adicione algumas transa√ß√µes para ver o gr√°fico</div>
                    </div>
                `;
                return;
            }
            
            // Prepara os dados
            const labels = [];
            const valores = [];
            const coresCartao = {
                'Cr√©dito': '#e74c3c',
                'D√©bito': '#3498db',
                'Pr√©-pago': '#2ecc71'
            };
            
            Object.entries(dadosCartao).forEach(([tipoCartao, dados]) => {
                labels.push(tipoCartao);
                valores.push(dados.total_gasto || 0);
            });
            
            const cores = labels.map(label => coresCartao[label] || '#95a5a6');
            
            // Destr√≥i gr√°fico anterior se existir
            if (cardTypeChart) {
                cardTypeChart.destroy();
            }
            
            cardTypeChart = new Chart(context, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor Total por Cart√£o',
                        data: valores,
                        backgroundColor: cores,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverBorderWidth: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 2,
                            bottom: 2,
                            left: 2,
                            right: 2
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 8,
                                usePointStyle: true,
                                font: {
                                    size: 9
                                },
                                boxWidth: 10,
                                boxHeight: 10
                            }
                        },
                        tooltip: {
                            titleFont: {
                                size: 10
                            },
                            bodyFont: {
                                size: 9
                            },
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed * 100) / total).toFixed(1) : 0;
                                    return `${context.label}: R$ ${context.parsed.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Base URL for API calls
        const API_BASE = 'http://localhost:5000/api';
        
        // Show/hide sections with optimized loading
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data based on section (com cache simples para evitar recarregamentos)
            if (sectionId === 'dashboard') {
                if (!window.dashboardLoaded) {
                    loadDashboard();
                    window.dashboardLoaded = true;
                }
            } else if (sectionId === 'users') {
                loadUsers();
            } else if (sectionId === 'transactions') {
                loadTransactions();
            } else if (sectionId === 'new-transaction') {
                if (!window.usersForSelectLoaded) {
                    loadUsersForSelect();
                    window.usersForSelectLoaded = true;
                }
            } else if (sectionId === 'reports') {
                if (!window.usersForReportsLoaded) {
                    loadUsersForReports();
                    window.usersForReportsLoaded = true;
                }
            }
        }

        // Load dashboard data with parallel API calls for better performance
        async function loadDashboard() {
            try {
                // Cria todas as promessas simultaneamente
                const healthPromise = fetch(`${API_BASE.replace('/api', '')}/health`);
                const usersPromise = fetch(`${API_BASE}/users`);
                const transactionsPromise = fetch(`${API_BASE}/transactions`);
                
                // Executa todas as requisi√ß√µes em paralelo
                const [healthResponse, usersResponse, transactionsResponse] = await Promise.all([
                    healthPromise,
                    usersPromise,
                    transactionsPromise
                ]);
                
                // Processa os resultados em paralelo
                const [health, users, transactionsData] = await Promise.all([
                    healthResponse.json(),
                    usersResponse.json(),
                    transactionsResponse.json()
                ]);
                
                // Atualiza o status de sa√∫de
                let healthHtml = '<table class="table"><tr><th>Servi√ßo</th><th>Status</th><th>URL</th></tr>';
                healthHtml += `<tr><td>Gateway</td><td>‚úÖ ${health.gateway_status}</td><td>http://localhost:5000</td></tr>`;
                
                for (const [service, info] of Object.entries(health.servicos)) {
                    const status = info.codigo === 200 ? '‚úÖ Ativo' : '‚ùå Inativo';
                    healthHtml += `<tr><td>${service}</td><td>${status}</td><td>${info.url}</td></tr>`;
                }
                healthHtml += '</table>';
                document.getElementById('health-status').innerHTML = healthHtml;

                // Atualiza estat√≠sticas do dashboard
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('total-transactions').textContent = transactionsData.count || 0;
                
                const totalAmount = transactionsData.transacoes?.reduce((sum, t) => sum + t.valor, 0) || 0;
                document.getElementById('total-amount').textContent = `R$ ${totalAmount.toFixed(2)}`;
                
                // Carrega os gr√°ficos
                await loadCharts();
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                // Fallback para carregar dados individualmente em caso de erro
                await loadDashboardFallback();
            }
        }
        
        // Fun√ß√£o fallback para carregar dados individualmente
        async function loadDashboardFallback() {
            try {
                // Load health status
                const healthResponse = await fetch(`${API_BASE.replace('/api', '')}/health`);
                const health = await healthResponse.json();
                
                let healthHtml = '<table class="table"><tr><th>Servi√ßo</th><th>Status</th><th>URL</th></tr>';
                healthHtml += `<tr><td>Gateway</td><td>‚úÖ ${health.gateway_status}</td><td>http://localhost:5000</td></tr>`;
                
                for (const [service, info] of Object.entries(health.servicos)) {
                    const status = info.codigo === 200 ? '‚úÖ Ativo' : '‚ùå Inativo';
                    healthHtml += `<tr><td>${service}</td><td>${status}</td><td>${info.url}</td></tr>`;
                }
                healthHtml += '</table>';
                document.getElementById('health-status').innerHTML = healthHtml;

                // Load summary stats individually
                const usersResponse = await fetch(`${API_BASE}/users`);
                const users = await usersResponse.json();
                document.getElementById('total-users').textContent = users.length;

                const transactionsResponse = await fetch(`${API_BASE}/transactions`);
                const transactionsData = await transactionsResponse.json();
                document.getElementById('total-transactions').textContent = transactionsData.count || 0;
                
                const totalAmount = transactionsData.transacoes?.reduce((sum, t) => sum + t.valor, 0) || 0;
                document.getElementById('total-amount').textContent = `R$ ${totalAmount.toFixed(2)}`;
                
            } catch (error) {
                console.error('Erro ao carregar dashboard (fallback):', error);
                document.getElementById('health-status').innerHTML = '<div class="alert alert-error">Erro ao carregar status dos servi√ßos</div>';
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const users = await response.json();
                
                let html = '<table class="table"><tr><th>ID</th><th>Nome</th><th>Email</th><th>Data Cria√ß√£o</th></tr>';
                users.forEach(user => {
                    const date = new Date(user.data_criacao).toLocaleDateString('pt-BR');
                    html += `<tr><td>${user.id}</td><td>${user.nome}</td><td>${user.email}</td><td>${date}</td></tr>`;
                });
                html += '</table>';
                
                document.getElementById('users-list').innerHTML = html;
            } catch (error) {
                document.getElementById('users-list').innerHTML = '<div class="alert alert-error">Erro ao carregar usu√°rios</div>';
            }
        }

        // Load transactions with edit and delete functionality
        async function loadTransactions() {
            try {
                const response = await fetch(`${API_BASE}/transactions`);
                const data = await response.json();
                
                let html = '<table class="table"><tr><th>ID</th><th>Usu√°rio ID</th><th>Descri√ß√£o</th><th>Valor</th><th>Cart√£o</th><th>Data</th><th>A√ß√µes</th></tr>';
                data.transacoes.forEach(transaction => {
                    const date = new Date(transaction.data_lancamento).toLocaleDateString('pt-BR');
                    const valor = `R$ ${transaction.valor.toFixed(2)}`;
                    const cartao = `${transaction.cartao_tipo} ****${transaction.cartao_final}`;
                    html += `<tr>
                        <td>${transaction.id}</td>
                        <td>${transaction.usuario_id}</td>
                        <td>${transaction.descricao}</td>
                        <td>${valor}</td>
                        <td>${cartao}</td>
                        <td>${date}</td>
                        <td class="action-buttons">
                            <button class="btn-edit" onclick="editTransaction(${transaction.id})" title="Editar transa√ß√£o">‚úèÔ∏è Editar</button>
                            <button class="btn-delete" onclick="confirmDeleteTransaction(${transaction.id}, '${transaction.descricao}')" title="Excluir transa√ß√£o">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                
                document.getElementById('transactions-list').innerHTML = html;
            } catch (error) {
                document.getElementById('transactions-list').innerHTML = '<div class="alert alert-error">Erro ao carregar transa√ß√µes</div>';
            }
        }

        // Load users for select dropdown
        async function loadUsersForSelect() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const users = await response.json();
                
                const select = document.getElementById('transaction-user');
                select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
                
                users.forEach(user => {
                    select.innerHTML += `<option value="${user.id}">${user.nome} (${user.email})</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        }

        // Load users for reports
        async function loadUsersForReports() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const users = await response.json();
                
                const select = document.getElementById('report-user');
                select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
                
                users.forEach(user => {
                    select.innerHTML += `<option value="${user.id}">${user.nome} (${user.email})</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        }

        // Form handlers
        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userData = {
                nome: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    showAlert('Usu√°rio criado com sucesso!', 'success');
                    this.reset();
                    loadUsers();
                } else {
                    throw new Error('Erro ao criar usu√°rio');
                }
            } catch (error) {
                showAlert('Erro ao criar usu√°rio', 'error');
            }
        });

        document.getElementById('transaction-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const transactionData = {
                usuario_id: parseInt(document.getElementById('transaction-user').value),
                descricao: document.getElementById('transaction-description').value,
                valor: parseFloat(document.getElementById('transaction-amount').value),
                cartao_tipo: document.getElementById('transaction-card-type').value,
                cartao_final: document.getElementById('transaction-card-final').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                });
                
                if (response.ok) {
                    showAlert('Transa√ß√£o criada com sucesso!', 'success');
                    this.reset();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.mensagem || 'Erro ao criar transa√ß√£o');
                }
            } catch (error) {
                showAlert(`Erro ao criar transa√ß√£o: ${error.message}`, 'error');
            }
        });

        // Clear transaction form
        function clearTransactionForm() {
            document.getElementById('transaction-form').reset();
        }

        // Generate report
        async function generateReport() {
            const userId = document.getElementById('report-user').value;
            if (!userId) {
                showAlert('Selecione um usu√°rio', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/reports/user/${userId}`);
                const report = await response.json();
                
                let html = '<div class="card">';
                html += `<h3>üìä Relat√≥rio - ${report.usuario.nome}</h3>`;
                html += `<p><strong>Email:</strong> ${report.usuario.email}</p>`;
                html += `<h4>üí∞ Resumo Financeiro</h4>`;
                html += `<p><strong>Total de Transa√ß√µes:</strong> ${report.resumo_financeiro.total_transacoes}</p>`;
                html += `<p><strong>Total Gasto:</strong> R$ ${report.resumo_financeiro.total_gasto.toFixed(2)}</p>`;
                
                if (report.transacoes.length > 0) {
                    html += '<h4>üìã √öltimas Transa√ß√µes</h4>';
                    html += '<table class="table"><tr><th>Descri√ß√£o</th><th>Valor</th><th>Cart√£o</th><th>Data</th></tr>';
                    report.transacoes.forEach(t => {
                        const date = new Date(t.data_lancamento).toLocaleDateString('pt-BR');
                        html += `<tr><td>${t.descricao}</td><td>R$ ${t.valor.toFixed(2)}</td><td>${t.cartao_tipo} ****${t.cartao_final}</td><td>${date}</td></tr>`;
                    });
                    html += '</table>';
                }
                html += '</div>';
                
                document.getElementById('report-content').innerHTML = html;
            } catch (error) {
                showAlert('Erro ao gerar relat√≥rio', 'error');
            }
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Insert at the beginning of the active section
            const activeSection = document.querySelector('.section.active');
            activeSection.insertBefore(alertDiv, activeSection.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Edit and Delete Transaction Functions
        async function editTransaction(transactionId) {
            try {
                // Busca os dados da transa√ß√£o
                const response = await fetch(`${API_BASE}/transactions/${transactionId}`);
                if (!response.ok) {
                    throw new Error('Transa√ß√£o n√£o encontrada');
                }
                
                const transaction = await response.json();
                
                // Preenche o modal com os dados da transa√ß√£o
                document.getElementById('edit-transaction-id').value = transaction.id;
                document.getElementById('edit-transaction-description').value = transaction.descricao;
                document.getElementById('edit-transaction-amount').value = transaction.valor;
                document.getElementById('edit-transaction-card-type').value = transaction.cartao_tipo;
                document.getElementById('edit-transaction-card-final').value = transaction.cartao_final;
                
                // Exibe o modal
                document.getElementById('editModal').style.display = 'block';
                
            } catch (error) {
                showAlert(`Erro ao carregar transa√ß√£o: ${error.message}`, 'error');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('edit-transaction-form').reset();
        }

        async function confirmDeleteTransaction(transactionId, description) {
            const confirmMessage = `Tem certeza que deseja excluir a transa√ß√£o "${description}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`;
            
            if (confirm(confirmMessage)) {
                await deleteTransaction(transactionId);
            }
        }

        async function deleteTransaction(transactionId) {
            try {
                const response = await fetch(`${API_BASE}/transactions/${transactionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showAlert('Transa√ß√£o exclu√≠da com sucesso!', 'success');
                    loadTransactions(); // Recarrega a lista
                    
                    // Atualiza o dashboard se estivermos na aba de dashboard
                    const activeSection = document.querySelector('.section.active');
                    if (activeSection && activeSection.id === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.mensagem || 'Erro ao excluir transa√ß√£o');
                }
            } catch (error) {
                showAlert(`Erro ao excluir transa√ß√£o: ${error.message}`, 'error');
            }
        }

        // Form handler for editing transactions
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('edit-transaction-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const transactionId = document.getElementById('edit-transaction-id').value;
                const transactionData = {
                    descricao: document.getElementById('edit-transaction-description').value,
                    valor: parseFloat(document.getElementById('edit-transaction-amount').value),
                    cartao_tipo: document.getElementById('edit-transaction-card-type').value,
                    cartao_final: document.getElementById('edit-transaction-card-final').value
                };
                
                try {
                    const response = await fetch(`${API_BASE}/transactions/${transactionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(transactionData)
                    });
                    
                    if (response.ok) {
                        showAlert('Transa√ß√£o atualizada com sucesso!', 'success');
                        closeEditModal();
                        loadTransactions(); // Recarrega a lista
                        
                        // Atualiza o dashboard se estivermos na aba de dashboard
                        const activeSection = document.querySelector('.section.active');
                        if (activeSection && activeSection.id === 'dashboard') {
                            loadDashboard();
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.mensagem || 'Erro ao atualizar transa√ß√£o');
                    }
                } catch (error) {
                    showAlert(`Erro ao atualizar transa√ß√£o: ${error.message}`, 'error');
                }
            });
            
            // Fecha o modal quando clica fora dele
            window.onclick = function(event) {
                const modal = document.getElementById('editModal');
                if (event.target === modal) {
                    closeEditModal();
                }
            };
            
            // Initialize dashboard on page load
            loadDashboard();
        });
    </script>
</body>
</html>